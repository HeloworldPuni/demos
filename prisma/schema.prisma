generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  walletAddress String   @unique
  farcasterId   String?  @unique
  farcasterHandle String? // Feature 10: Social
  farcasterLinkedAt DateTime?
  
  xUserId       String?  @unique // Feature 10: Social
  xHandle       String?
  xLinkedAt     DateTime?

  createdAt     DateTime @default(now())

  // Referral System
  referralPointsTotal      Float @default(0)
  referralRewardsClaimable Float @default(0)
  referralRewardsClaimed   Float @default(0)

  invites   Invite[]
  referrals Referral[] @relation("Referrer")
  referred  Referral?  @relation("Referee")

  // Feature 9: Clan System
  clanMembers    CartelReferral[] @relation("ClanBoss")
  clanMembership CartelReferral?  @relation("ClanMember")

  // Feature 6: Last Seen
  // Feature 6: Last Seen
  lastSeenAt DateTime?
  shares     Int       @default(0) // Added for Feature 8 title calc
  rep        Int       @default(0) // Feature 10: Reputation
  questProgress UserQuestProgress[]
  pendingShares PendingShare[]
}

model CartelReferral {
  id              String   @id @default(uuid())
  userAddress     String   @unique
  user            User     @relation("ClanMember", fields: [userAddress], references: [walletAddress])
  referrerAddress String
  referrer        User     @relation("ClanBoss", fields: [referrerAddress], references: [walletAddress])
  season          Int      @default(1)
  joinedAt        DateTime @default(now())

  @@index([referrerAddress])
}

model Invite {
  id        String   @id @default(uuid())
  code      String   @unique
  creatorId String?
  creator   User?    @relation(fields: [creatorId], references: [id])
  status    String   @default("unused") // unused, used
  type      String   @default("standard") // founder, standard
  maxUses   Int      @default(1)
  usedCount Int      @default(0)
  createdAt DateTime @default(now())

  referral Referral?
}

model Referral {
  id         String   @id @default(uuid())
  referrerId String
  referrer   User     @relation("Referrer", fields: [referrerId], references: [id])
  refereeId  String   @unique
  referee    User     @relation("Referee", fields: [refereeId], references: [id])
  inviteId   String   @unique
  invite     Invite   @relation(fields: [inviteId], references: [id])
  joinedAt   DateTime @default(now())

  // Tracking Metrics
  totalFeesPaidByReferee          Float   @default(0)
  totalProfitShareEarnedByReferee Float   @default(0)
  referralPoints                  Float   @default(0)
  isRewardable                    Boolean @default(true)
}

model CartelEvent {
  id                String      @id @default(uuid())
  txHash            String      @unique
  blockNumber       Int
  timestamp         DateTime
  type              String // RAID, HIGH_STAKES_RAID, RETIRE
  attacker          String?
  target            String?
  user              String? // For RETIRE
  stolenShares      Float?
  selfPenaltyShares Float?
  feePaid           Float?
  payout            Float?
  processed         Boolean     @default(false)
  createdAt         DateTime    @default(now())
  news              CartelNews?

  @@index([timestamp(sort: Desc)])
}

model CartelNews {
  id             String      @id @default(uuid())
  eventId        String      @unique
  event          CartelEvent @relation(fields: [eventId], references: [id])
  type           String // RAID, HIGH_STAKES_RAID, RETIRE
  headline       String
  timestamp      DateTime
  attacker       String?
  target         String?
  user           String?
  importance     Int         @default(1)
  postedToSocial Boolean     @default(false)
  txHash         String?
  createdAt      DateTime    @default(now())

  @@index([timestamp(sort: Desc)])
}

// --- QUEST SYSTEM ---

enum QuestCategory {
  SOCIAL
  GAMEPLAY
  REFERRAL
  SYSTEM
}

enum QuestFrequency {
  DAILY
  WEEKLY
  SEASONAL
  ONE_TIME
}

model Quest {
  id              String         @id @default(uuid())
  slug            String         @unique
  title           String
  description     String
  category        QuestCategory
  frequency       QuestFrequency
  rewardRep       Int            @default(0)
  rewardShares    Int            @default(0)
  maxCompletions  Int            @default(1)
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  progress        UserQuestProgress[]
}

model UserQuestProgress {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  questId         String
  quest           Quest     @relation(fields: [questId], references: [id])
  completedCount  Int       @default(0)
  lastResetAt     DateTime  @default(now())
  lastCompletedAt DateTime?

  @@unique([userId, questId])
}

// --- SHARE REWARDS & ANTI-ABUSE ---

enum ShareStatus {
  PENDING
  APPROVED
  MINTED
  REJECTED
}

model PendingShare {
  id        String      @id @default(uuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id])
  amount    Int
  reason    String
  status    ShareStatus @default(PENDING)
  txHash    String?
  createdAt DateTime    @default(now())

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model FraudEvent {
  id        String   @id @default(uuid())
  userId    String?
  reason    String
  details   String?
  createdAt DateTime @default(now())

  @@index([userId])
}

model NotificationToken {
  id        String   @id @default(uuid())
  fid       String
  token     String   @unique
  url       String
  createdAt DateTime @default(now())
  
  @@unique([fid, token])
  @@index([fid])
}
